name: Unit & Integration Tests

on:
  push:
    branches:
      - main
      - unit-tests
      - data-preprocessing
      - api-tests
  pull_request:
    branches:
      - main

jobs:
  # Job 1: Code Quality Checks
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dev dependencies
        run: |
          uv sync --group dev

      - name: Lint with ruff
        run: |
          uv run ruff check src/ tests/

      - name: Check code formatting
        run: |
          uv run black --check src/ tests/ || echo "Formatting issues found"

  # Job 2: Data Tests (from unit_tests/test_data.py)
  data-tests:
    runs-on: ubuntu-latest
    needs: [code-quality]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync

      - name: Run data tests
        run: |
          echo "Running data tests..."
          uv run pytest tests/unit_tests/test_data.py -v --tb=short

      - name: Upload data test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: data-test-results
          path: |
            .pytest_cache/
          retention-days: 1

  # Job 3: Model Tests (from unit_tests/test_model.py)
  model-tests:
    runs-on: ubuntu-latest
    needs: [data-tests]  # Run after data tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --group dev

      - name: Create dummy model directory for tests
        run: |
          mkdir -p outputs/models
          echo "Created models directory for testing"

      - name: Run model tests
        run: |
          echo "Running model tests..."
          uv run pytest tests/unit_tests/test_model.py -v --tb=short

  # Job 4: API Integration Tests (from integration_tests/test_api.py)
  api-tests:
    runs-on: ubuntu-latest
    needs: [model-tests]  # Run after model tests
    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: |
          uv sync --group dev
          # Ensure API testing dependencies are installed
          uv pip install httpx pytest-asyncio pytest-httpx

      - name: Create dummy model files for API testing
        run: |
          mkdir -p outputs/models
          python -c "
          import torch
          import os
          
          # Create a simple dummy model
          class DummyModel(torch.nn.Module):
              def __init__(self):
                  super().__init__()
                  self.fc = torch.nn.Linear(10, 2)
              
              def forward(self, x):
                  return torch.tensor([[2.0, 1.0]])
          
          model = DummyModel()
          
          # Save dummy models for all expected model types
          for model_name in ['baseline', 'alexnet', 'vgg16']:
              torch.save(
                  model.state_dict(), 
                  f'outputs/models/{model_name}_best.pth'
              )
              print(f'Created dummy model: {model_name}_best.pth')
          
          # List created files
          print('Models directory contents:')
          for f in os.listdir('outputs/models'):
              print(f'  - {f}')
          "

      - name: Run API integration tests
        run: |
          echo "Running API integration tests..."
          uv run pytest tests/integration_tests/test_.py -v --tb=short --junitxml=api-test-results.xml

      - name: Run additional API tests if they exist
        run: |
          # Check if there are other API test files
          if ls tests/integration_tests/test_*.py 2>/dev/null; then
            echo "Running additional API tests..."
            uv run pytest tests/integration_tests/test_*.py -v --tb=short
          else
            echo "No additional API test files found"
          fi

      - name: Upload API test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: api-test-results-${{ matrix.python-version }}
          path: |
            api-test-results.xml
            outputs/models/
          retention-days: 7

  # Job 5: All Tests Summary & Coverage
  test-summary:
    runs-on: ubuntu-latest
    needs: [data-tests, model-tests, api-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv sync --group dev

      - name: Run all tests with coverage
        run: |
          echo "Running comprehensive test suite..."
          
          # Create dummy models if needed
          mkdir -p outputs/models
          
          # Run all tests with coverage
          uv run coverage run --source=src/main_project -m pytest tests/ -v
          
          # Generate coverage report
          uv run coverage report -m
          uv run coverage html
          
          # Generate XML report for CI tools
          uv run coverage xml

      - name: Generate test summary
        run: |
          echo "ðŸ“Š TEST SUMMARY"
          echo "================"
          echo ""
          echo "Test Structure:"
          echo "- Data Tests: tests/unit_tests/test_data.py"
          echo "- Model Tests: tests/unit_tests/test_model.py"
          echo "- API Tests: tests/integration_tests/test_api.py"
          echo ""
          echo "âœ… All test jobs completed"

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false